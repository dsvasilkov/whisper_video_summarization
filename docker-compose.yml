version: '3.8'

services:
  fastapi:
    build:
      context: .
      args:
        POETRY_GROUPS: "inference,mlops"
    container_name: whisper-fastapi
    command: uvicorn whisper_video_summarization.api.app:app --host 0.0.0.0 --port 8000 --log-level debug
    volumes:
      - .:/app
      - ./mlflow.db:/app/mlflow.db
      - ./data:/app/data
      - ./whisper_video_summarization/models:/app/whisper_video_summarization/models
      - ./configs:/app/configs
      - ./tmp:/app/tmp
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=DEBUG
    working_dir: /app
    networks:
      - whisper-network

  mlflow:
    build:
      context: .
      args:
        POETRY_GROUPS: "mlflow"
    container_name: whisper-mlflow
    command: >
      bash -c "mkdir -p /app/mlruns &&
      touch /app/mlflow.db &&
      mlflow server
      --host 0.0.0.0
      --port 8080
      --backend-store-uri sqlite:///app/mlflow.db
      --default-artifact-root /app/mlruns"
    volumes:
      - .:/app
      - ./mlruns:/app/mlruns
    ports:
      - "8080:8080"
    environment:
      - PYTHONPATH=/app
    working_dir: /app
    networks:
      - whisper-network

  streamlit:
    build:
      context: .
      args:
        POETRY_GROUPS: "streamlit"
    container_name: whisper-streamlit
    command: streamlit run whisper_video_summarization/streamlit/app.py --server.address 0.0.0.0 --server.port 8501
    volumes:
      - .:/app
      - ./mlflow.db:/app/mlflow.db
      - ./data:/app/data
      - ./whisper_video_summarization/models:/app/whisper_video_summarization/models
      - ./configs:/app/configs
      - ./tmp:/app/tmp
    ports:
      - "8501:8501"
    environment:
      - PYTHONPATH=/app
      - API_URL=http://fastapi:8000
    working_dir: /app
    networks:
      - whisper-network
    depends_on:
      fastapi:
        condition: service_healthy

networks:
  whisper-network:
    driver: bridge

